<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üìä Aggregatore Notizie Finanziarie</title>
    
    <!-- Mobile optimization -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    
    <style>
        /* ======================================== */
        /* RESET & BASE STYLES */
        /* ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-light: #f8f9fa;
            --gray: #6b7280;
            --gray-dark: #374151;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

/* ======================================== */
/* HEADER & TABS - MOBILE FRIENDLY */
/* ======================================== */
.header {
    background: var(--white);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    position: sticky;
    top: 15px;
    z-index: 100;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

h1 {
    color: var(--gray-dark);
    margin-bottom: 15px;
    font-size: 1.5rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.tabs-container {
    position: relative;
    overflow: hidden;
}

.tabs {
    display: flex;
    flex-wrap: wrap;  /* Permette andare a capo */
    gap: 5px;
    margin: 0;
    padding-bottom: 5px;
}

.tab {
    padding: 12px 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--gray);
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    font-weight: 500;
}

.tab:hover {
    color: var(--primary);
    background: rgba(102, 126, 234, 0.05);
}

.tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    font-weight: 600;
    background: rgba(102, 126, 234, 0.08);
}

/* Su schermi piccoli: tab pi√π stretti */
@media (max-width: 480px) {
    .tab {
        flex: 1 0 calc(50% - 3px); /* 2 tab per riga */
        min-width: 0; /* Permette di restringersi */
        text-align: center;
        padding: 10px 8px;
        font-size: 0.8rem;
    }
}

/* Su schermi medi: tab si adattano */
@media (min-width: 481px) and (max-width: 768px) {
    .tab {
        flex: 1; /* Tutti uguali, si restringono */
        min-width: 100px; /* Larghezza minima */
        text-align: center;
    }
}

/* Su schermi grandi: dimensioni normali */
@media (min-width: 769px) {
    .tab {
        flex: 1;
        max-width: 200px; /* Larghezza massima */
    }
}       



/* ======================================== */
/* BUTTONS - TOUCH FRIENDLY */
/* ======================================== */
button {
    background: var(--primary);
    color: var(--white);
    border: none;
    padding: 14px 20px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-height: 48px;
    touch-action: manipulation;
    width: 100%;
}

button:active {
    transform: scale(0.98);
}

button:hover {
    background: var(--primary-dark);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

button:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
}

.btn-success {
    background: var(--success);
}

.btn-success:hover {
    background: #059669;
}

.btn-danger {
    background: var(--danger);
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-warning {
    background: var(--warning);
}

.btn-warning:hover {
    background: #d97706;
}

.btn-secondary {
    background: var(--gray);
}

.btn-secondary:hover {
    background: var(--gray-dark);
}

.btn-nuclear {
    background: linear-gradient(45deg, #ef4444, #f59e0b);
    font-weight: 700;
}

.btn-nuclear:hover {
    background: linear-gradient(45deg, #dc2626, #d97706);
    transform: scale(1.02);
}

/* ======================================== */
/* BOTTONE CESTINO NELLE KEYWORDS - MODIFICA */
/* ======================================== */
.keyword-header .btn-danger {
    width: auto !important;
    min-width: 40px !important;
    max-width: 40px !important;
    height: 32px !important;
    padding: 0 !important;
    flex-shrink: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-height: auto !important;
}

.keyword-header .btn-danger:hover {
    background: #dc2626;
    box-shadow: none;
}






        /* ======================================== */
        /* CONTENT AREAS */
        /* ======================================== */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
            font-size: 1.2rem;
        }

        /* ======================================== */
        /* FORMS - MOBILE OPTIMIZED .*/
        /* ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-dark);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-sm);
            font-size: 16px; /* Previene zoom automatico iOS */
            transition: border-color 0.2s;
            background: var(--white);
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'SF Mono', Monaco, 'Cascadia Mono', monospace;
            line-height: 1.4;
        }

        /* ======================================== */
        /* LISTS & ITEMS */
        /* ======================================== */
        .feed-list {
            list-style: none;
        }

        .feed-item {
            background: var(--gray-light);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .feed-item:active {
            transform: scale(0.99);
        }

        .feed-item-info {
            flex: 1;
        }

        .feed-item-category {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .feed-item-url {
            color: var(--gray);
            font-size: 0.85rem;
            word-break: break-all;
            line-height: 1.4;
        }

        /* ======================================== */
        /* KEYWORDS SECTION */
        /* ======================================== */
        .keyword-section {
            background: var(--gray-light);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
        }

        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .keyword-title {
            font-weight: 600;
            color: var(--gray-dark);
            font-size: 1.1rem;
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .keyword-tag {
            background: var(--primary);
            color: var(--white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ======================================== */
        /* NEWS DISPLAY - MOBILE OPTIMIZED */
        /* ======================================== */
        .category {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .category h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
            font-size: 1.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-count {
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: normal;
            background: var(--gray-light);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .article {
            background: var(--gray-light);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--primary);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .article:active {
            transform: translateX(4px);
        }

        .article::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .article:active::after {
            left: 100%;
        }

        .article-title {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.4;
        }

      .article-link {
    color: var(--primary);
    text-decoration: none;
    font-size: 0.9rem;
    word-break: break-all;
    display: block;
    margin-bottom: 8px;
    padding: 8px 0;
    /* AGGIUNGI QUESTE 3 RIGHE */
    position: relative;
    z-index: 10;
    cursor: pointer !important;
}

.article-link:active {
    opacity: 0.8;
}

        .article-date {
            color: var(--gray);
            font-size: 0.85rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .article-source {
            display: inline-block;
            background: #e5e7eb;
            color: var(--gray-dark);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* ======================================== */
        /* LOADING & STATUS */
        /* ======================================== */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid rgba(243, 243, 243, 0.8);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box, .error-box, .warning-box {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin: 15px 0;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .info-box {
            background: #dbeafe;
            border-left-color: #3b82f6;
            color: #1e40af;
        }

        .error-box {
            background: #fee2e2;
            border-left-color: #ef4444;
            color: #991b1b;
        }

        .warning-box {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }

        /* ======================================== */
        /* STATS & CONTROLS */
        /* ======================================== */
        .stats-bar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f4ff;
            border-radius: var(--radius);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .controls-row {
            display: flex;
            gap: 12px;
        }

        .reset-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        /* ======================================== */
        /* MOBILE SPECIFIC STYLES */
        /* ======================================== */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                background-attachment: fixed;
            }
            
            .header {
                padding: 15px;
                top: 12px;
            }
            
            h1 {
                font-size: 1.3rem;
                flex-direction: column;
                gap: 5px;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .config-section {
                padding: 16px;
            }
            
            .config-section h3 {
                font-size: 1.1rem;
            }
            
            .controls-row {
                flex-direction: column;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
            
            /* Touch-friendly sizes */
            button, .form-group input, .form-group select, .form-group textarea {
                min-height: 44px; /* Apple HIG minimum touch target */
            }
            
            .article {
                padding: 12px;
            }
            
            .category {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.6rem;
            }
            
            button {
                font-size: 0.95rem;
            }
        }

        @media (min-width: 769px) {
            .controls {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .controls button {
                width: auto;
                min-width: 160px;
            }
            
            .stats-bar {
                flex-direction: row;
                justify-content: space-around;
            }
            
            .stat-item {
                align-items: flex-start;
                text-align: left;
            }
        }

        /* ======================================== */
        /* DARK MODE SUPPORT */
        /* ======================================== */
        @media (prefers-color-scheme: dark) {
            :root {
                --gray-light: #1f2937;
                --gray: #9ca3af;
                --gray-dark: #f9fafb;
                --white: #111827;
            }
            
            body {
                background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            }
            
            .config-section, .header, .category, .article, .feed-item, .keyword-section {
                background: #1f2937;
                color: #f9fafb;
            }
            
            .article-title, .keyword-title, .form-group label {
                color: #f9fafb;
            }
            
            .feed-item-url, .article-date {
                color: #9ca3af;
            }
            
            .article-source {
                background: #374151;
                color: #d1d5db;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            
            .stats-bar {
                background: #374151;
            }
        }

        /* ======================================== */
        /* UTILITY CLASSES */
        /* ======================================== */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>
                <span>üìä</span>
                <span>Aggregatore Notizie Finanziarie</span>
            </h1>
            
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('results')">
                        <span>üì∞</span>
                        <span>Notizie</span>
                    </button>
                    <button class="tab" onclick="switchTab('feeds')">
                        <span>üì°</span>
                        <span>Feed RSS</span>
                    </button>
                    <button class="tab" onclick="switchTab('keywords')">
                        <span>üè∑Ô∏è</span>
                        <span>Parole Chiave</span>
                    </button>
                    <button class="tab" onclick="switchTab('settings')">
                        <span>‚öôÔ∏è</span>
                        <span>Impostazioni</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB NOTIZIE -->
        <div id="tab-results" class="tab-content active">
            <div class="config-section">
                <div class="controls">
                    <div class="controls-row">
                        <button onclick="loadNews()">
                            <span>üîÑ</span>
                            <span>Carica Notizie</span>
                        </button>
                        <button id="exportBtn" onclick="exportToHTML()" class="btn-success hidden">
                            <span>üì•</span>
                            <span>Esporta HTML</span>
                        </button>
                    </div>
                </div>
                <div id="statusMsg" class="mt-2"></div>
            </div>

            <div id="statsBar" class="config-section hidden">
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">Notizie Totali</span>
                        <span class="stat-value" id="totalNews">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ultime 24h</span>
                        <span class="stat-value" id="news24h">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Categorie</span>
                        <span class="stat-value" id="totalCategories">0</span>
                    </div>
                </div>
            </div>

            <div id="newsContent"></div>
        </div>

        <!-- TAB FEED RSS -->
        <div id="tab-feeds" class="tab-content">
            <div class="config-section">
                <h3>‚ûï Aggiungi Nuovo Feed</h3>
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="newFeedCategory" placeholder="es: Notizie Italia">
                </div>
                <div class="form-group">
                    <label>URL Feed RSS</label>
                    <input type="url" id="newFeedUrl" placeholder="https://esempio.it/feed">
                </div>
                <button onclick="addFeed()" class="btn-success">
                    <span>‚ûï</span>
                    <span>Aggiungi Feed</span>
                </button>
            </div>

            <div class="config-section">
                <h3>üìã Feed Configurati</h3>
                <ul id="feedsList" class="feed-list mt-2"></ul>
            </div>
        </div>

        <!-- TAB PAROLE CHIAVE -->
        <div id="tab-keywords" class="tab-content">
            <div class="config-section">
                <h3>‚ûï Aggiungi Gruppo di Parole Chiave</h3>
                <div class="form-group">
                    <label>Nome Sezione</label>
                    <input type="text" id="newKeywordSection" placeholder="es: ENI">
                </div>
                <div class="form-group">
                    <label>Parole Chiave (separate da virgola)</label>
                    <input type="text" id="newKeywords" placeholder="es: ENI, Eni, Saipem">
                </div>
                <button onclick="addKeywordSection()" class="btn-success">
                    <span>‚ûï</span>
                    <span>Aggiungi Gruppo</span>
                </button>
            </div>

            <div class="config-section">
                <h3>üè∑Ô∏è Gruppi di Parole Chiave</h3>
                <div id="keywordsList" class="mt-2"></div>
            </div>
        </div>

        <!-- TAB IMPOSTAZIONI -->
        <div id="tab-settings" class="tab-content">
            <div class="config-section">
                <h3>‚öôÔ∏è Configurazione Generale</h3>
                
                <div class="form-group">
                    <label>Filtro Temporale</label>
                    <select id="timeFilter">
                        <option value="24">Ultime 24 ore</option>
                        <option value="48">Ultime 48 ore</option>
                        <option value="72">Ultimi 3 giorni</option>
                        <option value="168">Ultima settimana</option>
                        <option value="0">Tutte le notizie</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Modalit√† Raggruppamento</label>
                    <select id="groupingMode">
                        <option value="source">Per Fonte RSS</option>
                        <option value="keyword">Per Parola Chiave</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Limite Notizie per Sezione</label>
                    <input type="number" id="newsLimit" value="20" min="5" max="100">
                </div>

                <div class="form-group">
                    <label>Evidenzia notizie MIB40</label>
                    <select id="highlightMIB40">
                        <option value="true">S√¨</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rilevamento automatico ticker</label>
                    <select id="autoDetectTickers">
                        <option value="true">Attivo</option>
                        <option value="false">Disattivo</option>
                    </select>
                </div>

                <button onclick="saveSettings()" class="btn-success mt-2">
                    <span>üíæ</span>
                    <span>Salva Impostazioni</span>
                </button>
            </div>

            <div class="config-section">
                <h3>üîÑ Ripristino Configurazioni</h3>
                <div class="reset-buttons">
                    <button onclick="resetSystemSettings()" class="btn-warning">
                        <span>‚öôÔ∏è</span>
                        <span>Ripristina Impostazioni</span>
                    </button>
                    
                    <button onclick="resetFeeds()" class="btn-danger">
                        <span>üì°</span>
                        <span>Ripristina Feed</span>
                    </button>
                    
                    <button onclick="resetKeywords()" class="btn-danger">
                        <span>üè∑Ô∏è</span>
                        <span>Ripristina Parole Chiave</span>
                    </button>
                    
                    <button onclick="resetFeedsMIB40()" class="btn-success">
                        <span>üìà</span>
                        <span>Feed Focus MIB40</span>
                    </button>

                    <button onclick="resetEverything()" class="btn-nuclear">
                        <span>‚ò¢Ô∏è</span>
                        <span>Ripristino Completo</span>
                    </button>
                </div>
            </div>

    
        
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURAZIONE INIZIALE - POTENZIATA PER MIB40
        // ========================================
        let config = {
            feeds: {
                'Notizie Italia - Soldionline': ['https://www.soldionline.it/feed'],
                'Notizie Italia - Repubblica': ['https://www.repubblica.it/rss/economia/rss2.0.xml'],
                'Fed & Banche Centrali': ['https://www.federalreserve.gov/feeds/press_all.xml'],
                
                // NUOVI FEED SPECIFICI PER MIB40 E BLUECHIP ITALIANE
                'Borsa Italiana': [
                    'https://www.borsaitaliana.it/borsa/notizie/home/rss.xml',
                    'https://www.borsaitaliana.it/borsa/notizie/rss.xml'
                ],
                
                'Finanza Italiana': [
                    'https://www.milanofinanza.it/rss/mercati',
                    'https://www.ilsole24ore.com/rss/finanza-e-mercati.xml',
                    'https://www.teleborsa.it/rss/ultimenews.xml'
                ],
                
                'Analisi e Titoli': [
                    'https://www.investireoggi.it/feed/',
                    'https://www.tradingonline.it/feed/',
                    'https://www.finanzaonline.com/feed/'
                ],
                
                'Economia Generale': [
                    'https://www.corriere.it/rss/economia.xml',
                    'https://www.ansa.it/sito/ansait_rss.xml',
                    'https://www.agi.it/economia/rss'
                ]
            },
            
            keywords: {
                // Bluechip MIB40 - versione completa e migliorata
                'ENI': ['ENI', 'Eni', 'Eni S.p.A.', 'E.N.I.', 'ENI SpA'],
                'Enel': ['Enel', 'Enel S.p.A.', 'Enel Group', 'Enel Spa'],
                'Intesa Sanpaolo': ['Intesa Sanpaolo', 'Intesa', 'Sanpaolo', 'ISP', 'Intesa SanPaolo'],
                'UniCredit': ['UniCredit', 'Unicredit', 'UCG', 'UniCredit S.p.A.'],
                'Stellantis': ['Stellantis', 'Stellantis N.V.', 'STLA', 'Fiat Chrysler', 'FCA'],
                'Generali': ['Generali', 'Assicurazioni Generali', 'Generali Group', 'G'],
                'TIM': ['TIM', 'Telecom Italia', 'TIM S.p.A.', 'Telecom Italia S.p.A.'],
                'Poste Italiane': ['Poste Italiane', 'Poste', 'Poste Italiane S.p.A.'],
                'Mediobanca': ['Mediobanca', 'Mediobanca S.p.A.', 'MB'],
                'Leonardo': ['Leonardo', 'Leonardo S.p.A.', 'Leonardo Company', 'Finmeccanica'],
                'Monte Paschi': ['Monte dei Paschi', 'MPS', 'Banca MPS', 'BMPS', 'Banca Monte dei Paschi'],
                'Unipol': ['Unipol', 'UnipolSai', 'Unipol Gruppo', 'UnipolSai Assicurazioni'],
                'Ferrari': ['Ferrari', 'Ferrari N.V.', 'Ferrari S.p.A.', 'RACE'],
                'Campari': ['Campari', 'Campari Group', 'Davide Campari', 'DavideCampari'],
                'Prysmian': ['Prysmian', 'Prysmian S.p.A.', 'Prysmian Group', 'Prysmian Spa'],
                'Snam': ['Snam', 'Snam S.p.A.'],
                'Terna': ['Terna', 'Terna S.p.A.'],
                'Recordati': ['Recordati', 'Recordati S.p.A.', 'Recordati Industria Chimica e Farmaceutica'],
                'STMicroelectronics': ['STMicroelectronics', 'STM', 'ST Micro', 'STMicro', 'STM Group'],
                'Amplifon': ['Amplifon', 'Amplifon S.p.A.'],
                'Tenaris': ['Tenaris', 'Tenaris S.p.A.'],
                'Saipem': ['Saipem', 'Saipem S.p.A.'],
                'DiaSorin': ['DiaSorin', 'DiaSorin S.p.A.'],
                'Moncler': ['Moncler', 'Moncler S.p.A.'],
                'Buzzi': ['Buzzi Unicem', 'Buzzi', 'Buzzi Unicem S.p.A.'],
                'Hera': ['Hera', 'Hera S.p.A.', 'Gruppo Hera'],
                'Italgas': ['Italgas', 'Italgas S.p.A.'],
                'Azimut': ['Azimut', 'Azimut Holding'],
                'Fineco': ['FinecoBank', 'Fineco', 'Fineco Banca'],
                'Nexi': ['Nexi', 'Nexi S.p.A.'],
                'A2A': ['A2A', 'A2A S.p.A.', 'A2A Spa'],
                'Banco BPM': ['Banco BPM', 'BPM', 'Banco BPM S.p.A.'],
                'BPER': ['BPER', 'BPER Banca'],
                'Mediolanum': ['Mediolanum', 'Banca Mediolanum'],
                'Brunello Cucinelli': ['Brunello Cucinelli', 'Cucinelli', 'Brunello Cucinelli S.p.A.'],
                'Fincantieri': ['Fincantieri', 'Fincantieri S.p.A.'],
                'INWIT': ['INWIT', 'INWIT S.p.A.'],
                'Lottomatica': ['Lottomatica', 'Lottomatica S.p.A.', 'GTECH Lottomatica'],
                'Pop Sondrio': ['Banca Popolare di Sondrio', 'Popolare Sondrio', 'BPS'],

                // Settori e temi (utili per raggruppamento)
                'Energia': ['energia', 'gas', 'petrolio', 'oil', 'gas naturale', 'elettrico', 'rinnovabili', 'transizione energetica'],
                'Banche': ['banca', 'banche', 'credito', 'finanziario', 'prestiti', 'mutui', 'tassi', 'interesse'],
                'Assicurazioni': ['assicurazione', 'assicurazioni', 'polizza', 'ramo I', 'ramo III', 'premi'],
                'Automotive': ['auto', 'automotive', 'veicoli', 'auto elettriche', 'EV', 'ibrido'],
                'TLC': ['telecom', 'telecomunicazioni', 'fibra', '5G', 'mobile', 'telefonia'],
                'Utility': ['utility', 'servizi pubblici', 'rete', 'distribuzione', 'infrastrutture'],
                'Lusso': ['lusso', 'fashion', 'moda', 'alta gamma', 'premium', 'orologi', 'gioielli'],
                'Farmaceutica': ['farmaceutica', 'farmaci', 'vaccini', 'medicinali', 'salute', 'sanit√†']
            },
            
            settings: {
                timeFilter: 24,
                groupingMode: 'source',  // 'source' o 'keyword'
                newsLimit: 25,
                highlightMIB40: true,    // NUOVO: evidenzia notizie MIB40
                autoDetectTickers: true  // NUOVO: rileva automaticamente ticker
            }
        };

        let allNews = {};
        let newsData = [];

        // ========================================
        // CORE FUNCTIONS
        // ========================================
        function loadConfig() {
            try {
                const saved = localStorage.getItem('newsAggregatorConfig');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge con default per nuove propriet√†
                    config = {
                        feeds: parsed.feeds || config.feeds,
                        keywords: parsed.keywords || config.keywords,
                        settings: {
                            ...config.settings,
                            ...(parsed.settings || {})
                        }
                    };
                }
            } catch (e) {
                console.warn('Errore caricamento config, usando default', e);
            }
            updateUI();
        }

        // ========================================
        // NUOVE FUNZIONI HELPER PER MIB40
        // ========================================

        // Lista completa tickers MIB40 per matching avanzato
        const MIB40_TICKERS = {
            'ENI': ['ENI', 'ENI.MI'],
            'ENEL': ['ENEL', 'ENEL.MI', 'ENEL IM', 'ENE'],
            'INTESA SANPAOLO': ['ISP', 'ISP.MI', 'ISP IM', 'INTESA'],
            'UNICREDIT': ['UCG', 'UCG.MI', 'UCG IM', 'UNCR'],
            'STELLANTIS': ['STLA', 'STLA.MI', 'STLA IM', 'STLAM'],
            'GENERALI': ['G', 'G.MI', 'G IM', 'ASSGEN'],
            'TIM': ['TIT', 'TIT.MI', 'TIT IM', 'TELECOM ITALIA'],
            'POSTE ITALIANE': ['PST', 'PST.MI', 'PST IM'],
            'MEDIOBANCA': ['MB', 'MB.MI', 'MB IM', 'MEDIOB'],
            'LEONARDO': ['LDO', 'LDO.MI', 'LDO IM', 'FINMECCANICA'],
            'MONTE DEI PASCHI': ['BMPS', 'BMPS.MI', 'BMPS IM', 'MPS'],
            'UNIPOL': ['UNI', 'UNI.MI', 'UNI IM', 'UNIPOLSAI'],
            'FERRARI': ['RACE', 'RACE.MI', 'RACE IM'],
            'CAMPARI': ['CPR', 'CPR.MI', 'CPR IM'],
            'PRYSMIAN': ['PRY', 'PRY.MI', 'PRY IM'],
            'SNAM': ['SRG', 'SRG.MI', 'SRG IM'],
            'TERNA': ['TRN', 'TRN.MI', 'TRN IM'],
            'RECORDATI': ['REC', 'REC.MI', 'REC IM'],
            'STMICROELECTRONICS': ['STM', 'STM.MI', 'STM IM', 'STMICRO'],
            'AMPLIFON': ['AMP', 'AMP.MI', 'AMP IM'],
            'TENARIS': ['TEN', 'TEN.MI', 'TEN IM'],
            'SAIPEM': ['SPM', 'SPM.MI', 'SPM IM'],
            'DIASORIN': ['DIA', 'DIA.MI', 'DIA IM'],
            'MONCLER': ['MONC', 'MONC.MI', 'MONC IM'],
            'BUZZI': ['BZU', 'BZU.MI', 'BZU IM'],
            'HERA': ['HER', 'HER.MI', 'HER IM'],
            'ITALGAS': ['IG', 'IG.MI', 'IG IM'],
            'AZIMUT': ['AZM', 'AZM.MI', 'AZM IM'],
            'FINECO': ['FBK', 'FBK.MI', 'FBK IM'],
            'NEXI': ['NEXI', 'NEXI.MI', 'NEXI IM'],
            'A2A': ['A2A', 'A2A.MI', 'A2A IM'],
            'BANCO BPM': ['BAMI', 'BAMI.MI', 'BAMI IM'],
            'BPER': ['BPE', 'BPE.MI', 'BPE IM'],
            'MEDIOLANUM': ['BMED', 'BMED.MI', 'BMED IM'],
            'CUCINELLI': ['BC', 'BC.MI', 'BC IM'],
            'FIN CANTIERI': ['FCT', 'FCT.MI', 'FCT IM'],
            'INWIT': ['INW', 'INW.MI', 'INW IM'],
            'LOTTOMATICA': ['LTO', 'LTO.MI', 'LTO IM']
        };

        // Rileva tickers MIB40 in un testo
        function detectMIB40Tickers(text) {
            if (!text || !config.settings.autoDetectTickers) return [];
            
            const detected = [];
            const textUpper = text.toUpperCase();
            
            for (const [company, tickers] of Object.entries(MIB40_TICKERS)) {
                for (const ticker of tickers) {
                    // Cerca ticker come parola intera (evita match parziali)
                    const regex = new RegExp(`\\b${ticker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                    if (regex.test(text)) {
                        detected.push({
                            company: company,
                            ticker: ticker
                        });
                        break; // Non cercare altri ticker per la stessa azienda
                    }
                }
            }
            
            return detected;
        }

        function saveConfig() {
            try {
                localStorage.setItem('newsAggregatorConfig', JSON.stringify(config));
            } catch (e) {
                showStatus('‚ùå Errore salvataggio configurazione', 'error');
            }
        }

        function switchTab(tabName) {
            // Rimuovi active da tutti i tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Aggiungi active al tab cliccato
            event.currentTarget.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Scroll to top su mobile
            if (window.innerWidth < 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ========================================
        // FEED MANAGEMENT
        // ========================================
        function addFeed() {
            const category = document.getElementById('newFeedCategory').value.trim();
            const url = document.getElementById('newFeedUrl').value.trim();

            if (!category || !url) {
                showStatus('‚ùå Inserisci categoria e URL', 'error');
                return;
            }

            try {
                new URL(url); // Validazione URL
            } catch {
                showStatus('‚ùå URL non valido', 'error');
                return;
            }

            if (!config.feeds[category]) {
                config.feeds[category] = [];
            }

            if (config.feeds[category].includes(url)) {
                showStatus('‚ö†Ô∏è Feed gi√† presente', 'warning');
                return;
            }

            config.feeds[category].push(url);
            saveConfig();
            updateFeedsList();
            
            document.getElementById('newFeedCategory').value = '';
            document.getElementById('newFeedUrl').value = '';
            showStatus('‚úÖ Feed aggiunto con successo', 'success');
        }

        function removeFeed(category, url) {
            if (!confirm('Rimuovere questo feed?')) return;
            
            config.feeds[category] = config.feeds[category].filter(f => f !== url);
            if (config.feeds[category].length === 0) {
                delete config.feeds[category];
            }
            saveConfig();
            updateFeedsList();
            showStatus('‚úÖ Feed rimosso', 'success');
        }

        function updateFeedsList() {
            const list = document.getElementById('feedsList');
            list.innerHTML = '';

            if (Object.keys(config.feeds).length === 0) {
                list.innerHTML = '<div class="info-box">Nessun feed configurato</div>';
                return;
            }

            for (const [category, urls] of Object.entries(config.feeds)) {
                urls.forEach(url => {
                    const li = document.createElement('li');
                    li.className = 'feed-item';
                    li.innerHTML = `
                        <div class="feed-item-info">
                            <div class="feed-item-category">${escapeHTML(category)}</div>
                            <div class="feed-item-url">${escapeHTML(url)}</div>
                        </div>
                        <button class="btn-danger" onclick="removeFeed('${escapeHTML(category)}', '${escapeHTML(url)}')">
                            üóëÔ∏è Rimuovi
                        </button>
                    `;
                    list.appendChild(li);
                });
            }
        }

        // ========================================
        // KEYWORDS MANAGEMENT
        // ========================================
        function addKeywordSection() {
            const section = document.getElementById('newKeywordSection').value.trim();
            const keywordsStr = document.getElementById('newKeywords').value.trim();

            if (!section || !keywordsStr) {
                showStatus('‚ùå Inserisci nome sezione e parole chiave', 'error');
                return;
            }

            const keywords = keywordsStr.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);

            if (keywords.length === 0) {
                showStatus('‚ùå Inserisci almeno una parola chiave', 'error');
                return;
            }

            config.keywords[section] = keywords;
            saveConfig();
            updateKeywordsList();
            
            document.getElementById('newKeywordSection').value = '';
            document.getElementById('newKeywords').value = '';
            showStatus('‚úÖ Gruppo parole chiave aggiunto', 'success');
        }

        function removeKeywordSection(section) {
            if (!confirm(`Rimuovere il gruppo "${section}"?`)) return;
            
            delete config.keywords[section];
            saveConfig();
            updateKeywordsList();
            showStatus('‚úÖ Gruppo rimosso', 'success');
        }

        function updateKeywordsList() {
            const container = document.getElementById('keywordsList');
            container.innerHTML = '';

            if (Object.keys(config.keywords).length === 0) {
                container.innerHTML = '<div class="info-box">Nessun gruppo di parole chiave configurato</div>';
                return;
            }

            for (const [section, keywords] of Object.entries(config.keywords)) {
                const div = document.createElement('div');
                div.className = 'keyword-section';
                div.innerHTML = `
                    <div class="keyword-header">
                        <div class="keyword-title">${escapeHTML(section)}</div>
                        <button class="btn-danger" onclick="removeKeywordSection('${escapeHTML(section)}')">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="keyword-tags">
                        ${keywords.map(k => `<span class="keyword-tag">${escapeHTML(k)}</span>`).join('')}
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // ========================================
        // SETTINGS MANAGEMENT
        // ========================================
        function saveSettings() {
            config.settings.timeFilter = parseInt(document.getElementById('timeFilter').value) || 24;
            config.settings.groupingMode = document.getElementById('groupingMode').value;
            config.settings.newsLimit = parseInt(document.getElementById('newsLimit').value) || 20;
            config.settings.highlightMIB40 = document.getElementById('highlightMIB40').value === 'true';
            config.settings.autoDetectTickers = document.getElementById('autoDetectTickers').value === 'true';
            
            if (config.settings.newsLimit < 5) config.settings.newsLimit = 5;
            if (config.settings.newsLimit > 100) config.settings.newsLimit = 100;
            
            saveConfig();
            showStatus('‚úÖ Impostazioni salvate', 'success');
        }

        // ========================================
        // RESET FUNCTIONS (SEPARATE)
        // ========================================
        function resetSystemSettings() {
            if (!confirm('Ripristinare le impostazioni di sistema?\n\nFiltro temporale, modalit√† raggruppamento e limite notizie torneranno ai valori predefiniti.')) return;
            
            config.settings = {
                timeFilter: 24,
                groupingMode: 'source',
                newsLimit: 20
            };
            saveConfig();
            updateUI();
            showStatus('‚úÖ Impostazioni di sistema ripristinate', 'success');
        }

        function resetFeeds() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nRipristinare i feed RSS ai valori predefiniti?\n\nTutti i feed che hai aggiunto verranno eliminati!')) return;
            
            config.feeds = {
                'Notizie Italia - Soldionline': ['https://www.soldionline.it/feed'],
                'Notizie Italia - Repubblica': ['https://www.repubblica.it/rss/economia/rss2.0.xml'],
                'Fed & Banche Centrali': ['https://www.federalreserve.gov/feeds/press_all.xml'],


		 'Borsa Italiana': ['https://www.borsaitaliana.it/borsa/notizie/home/rss.xml',
                    'https://www.borsaitaliana.it/borsa/notizie/rss.xml'],
                
                'Finanza Italiana': [
                    'https://www.milanofinanza.it/rss/mercati',
                    'https://www.ilsole24ore.com/rss/finanza-e-mercati.xml',
                    'https://www.teleborsa.it/rss/ultimenews.xml'
                ],
                
                'Analisi e Titoli': [
                    'https://www.investireoggi.it/feed/',
                    'https://www.tradingonline.it/feed/',
                    'https://www.finanzaonline.com/feed/'
                ],
                
                'Economia Generale': [
                    'https://www.corriere.it/rss/economia.xml',
                    'https://www.ansa.it/sito/ansait_rss.xml',
                    'https://www.agi.it/economia/rss'
                ]







            };
            saveConfig();
            updateFeedsList();
            showStatus('‚úÖ Feed RSS ripristinati', 'success');
        }

        function resetKeywords() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE!\n\nRipristinare le parole chiave ai valori predefiniti?\n\nTutti i gruppi di parole chiave che hai creato verranno eliminati!')) return;
            
            config.keywords = {
                'A2A': ['A2A', 'A2A S.p.A.', 'A2A Spa'],
                'Amplifon': ['Amplifon', 'Amplifon S.p.A.'],
                'Generali': ['Generali', 'Assicurazioni Generali', 'Generali Group'],
                'Azimut': ['Azimut', 'Azimut Holding'],
                'Mediolanum': ['Mediolanum', 'Banca Mediolanum'],
                'Banco BPM': ['Banco BPM', 'BPM', 'Banco BPM S.p.A.'],
                'Monte Paschi': ['Monte dei Paschi', 'MPS', 'Banca MPS', 'BMPS'],
                'BPER': ['BPER', 'BPER Banca'],
                'Pop Sondrio': ['Banca Popolare di Sondrio', 'Popolare Sondrio', 'BPS'],
                'Cucinelli': ['Brunello Cucinelli', 'Cucinelli', 'Brunello Cucinelli S.p.A.'],
                'Buzzi': ['Buzzi Unicem', 'Buzzi', 'Buzzi Unicem S.p.A.'],
                'Campari': ['Campari', 'Campari Group', 'Davide Campari'],
                'DiaSorin': ['DiaSorin', 'DiaSorin S.p.A.'],
                'Enel': ['Enel', 'Enel S.p.A.', 'Enel Group'],
                'ENI': ['ENI', 'Eni', 'Eni S.p.A.', 'E.N.I.'],
                'Ferrari': ['Ferrari', 'Ferrari N.V.', 'Ferrari S.p.A.'],
                'Fincantieri': ['Fincantieri', 'Fincantieri S.p.A.'],
                'Fineco': ['FinecoBank', 'Fineco', 'Fineco Banca'],
                'Hera': ['Hera', 'Hera S.p.A.', 'Gruppo Hera'],
                'Intesa Sanpaolo': ['Intesa Sanpaolo', 'Intesa', 'Sanpaolo', 'ISP'],
                'INWIT': ['INWIT', 'INWIT S.p.A.'],
                'Italgas': ['Italgas', 'Italgas S.p.A.'],
                'Leonardo': ['Leonardo', 'Leonardo S.p.A.', 'Leonardo Company'],
                'Lottomatica': ['Lottomatica', 'Lottomatica S.p.A.', 'GTECH Lottomatica'],
                'Mediobanca': ['Mediobanca', 'Mediobanca S.p.A.'],
                'Moncler': ['Moncler', 'Moncler S.p.A.'],
                'Nexi': ['Nexi', 'Nexi S.p.A.'],
                'Poste Italiane': ['Poste Italiane', 'Poste', 'Poste Italiane S.p.A.'],
                'Prysmian': ['Prysmian', 'Prysmian S.p.A.', 'Prysmian Group'],
                'Recordati': ['Recordati', 'Recordati S.p.A.'],
                'Saipem': ['Saipem', 'Saipem S.p.A.'],
                'Snam': ['Snam', 'Snam S.p.A.'],
                'Stellantis': ['Stellantis', 'Stellantis N.V.'],
                'STMicroelectronics': ['STMicroelectronics', 'STMicro', 'STM', 'ST Micro'],
                'TIM': ['TIM', 'Telecom Italia', 'TIM S.p.A.', 'Telecom Italia S.p.A.'],
                'Tenaris': ['Tenaris', 'Tenaris S.p.A.'],
                'Terna': ['Terna', 'Terna S.p.A.'],
                'UniCredit': ['UniCredit', 'Unicredit', 'UCG', 'UniCredit S.p.A.'],
                'Unipol': ['Unipol', 'UnipolSai', 'Unipol Gruppo'],
            };
            saveConfig();
            updateKeywordsList();
            showStatus('‚úÖ Parole chiave ripristinate', 'success');
        }

        function resetEverything() {
            if (!confirm('‚ò¢Ô∏è ATTENZIONE NUCLEARE!\n\nRipristinare TUTTO ai valori di fabbrica?\n\n‚Ä¢ Impostazioni\n‚Ä¢ Feed RSS\n‚Ä¢ Parole chiave\n\nQuesta azione non pu√≤ essere annullata!')) return;
            
            config = {
                feeds: {
                    'Notizie Italia - Soldionline': ['https://www.soldionline.it/feed'],
                    'Notizie Italia - Repubblica': ['https://www.repubblica.it/rss/economia/rss2.0.xml'],
                    'Fed & Banche Centrali': ['https://www.federalreserve.gov/feeds/press_all.xml'],
                    
                    // NUOVI FEED SPECIFICI PER MIB40 E BLUECHIP ITALIANE
                    'Borsa Italiana': [
                        'https://www.borsaitaliana.it/borsa/notizie/home/rss.xml',
                        'https://www.borsaitaliana.it/borsa/notizie/rss.xml'
                    ],
                    
                    'Finanza Italiana': [
                        'https://www.milanofinanza.it/rss/mercati',
                        'https://www.ilsole24ore.com/rss/finanza-e-mercati.xml',
                        'https://www.teleborsa.it/rss/ultimenews.xml'
                    ],
                    
                    'Analisi e Titoli': [
                        'https://www.investireoggi.it/feed/',
                        'https://www.tradingonline.it/feed/',
                        'https://www.finanzaonline.com/feed/'
                    ],
                    
                    'Economia Generale': [
                        'https://www.corriere.it/rss/economia.xml',
                        'https://www.ansa.it/sito/ansait_rss.xml',
                        'https://www.agi.it/economia/rss'
                    ]
                },
                
                keywords: {
                    // Bluechip MIB40 - versione completa e migliorata
                    'ENI': ['ENI', 'Eni', 'Eni S.p.A.', 'E.N.I.', 'ENI SpA'],
                    'Enel': ['Enel', 'Enel S.p.A.', 'Enel Group', 'Enel Spa'],
                    'Intesa Sanpaolo': ['Intesa Sanpaolo', 'Intesa', 'Sanpaolo', 'ISP', 'Intesa SanPaolo'],
                    'UniCredit': ['UniCredit', 'Unicredit', 'UCG', 'UniCredit S.p.A.'],
                    'Stellantis': ['Stellantis', 'Stellantis N.V.', 'STLA', 'Fiat Chrysler', 'FCA'],
                    'Generali': ['Generali', 'Assicurazioni Generali', 'Generali Group', 'G'],
                    'TIM': ['TIM', 'Telecom Italia', 'TIM S.p.A.', 'Telecom Italia S.p.A.'],
                    'Poste Italiane': ['Poste Italiane', 'Poste', 'Poste Italiane S.p.A.'],
                    'Mediobanca': ['Mediobanca', 'Mediobanca S.p.A.', 'MB'],
                    'Leonardo': ['Leonardo', 'Leonardo S.p.A.', 'Leonardo Company', 'Finmeccanica'],
                    'Monte Paschi': ['Monte dei Paschi', 'MPS', 'Banca MPS', 'BMPS', 'Banca Monte dei Paschi'],
                    'Unipol': ['Unipol', 'UnipolSai', 'Unipol Gruppo', 'UnipolSai Assicurazioni'],
                    'Ferrari': ['Ferrari', 'Ferrari N.V.', 'Ferrari S.p.A.', 'RACE'],
                    'Campari': ['Campari', 'Campari Group', 'Davide Campari', 'DavideCampari'],
                    'Prysmian': ['Prysmian', 'Prysmian S.p.A.', 'Prysmian Group', 'Prysmian Spa'],
                    'Snam': ['Snam', 'Snam S.p.A.'],
                    'Terna': ['Terna', 'Terna S.p.A.'],
                    'Recordati': ['Recordati', 'Recordati S.p.A.', 'Recordati Industria Chimica e Farmaceutica'],
                    'STMicroelectronics': ['STMicroelectronics', 'STM', 'ST Micro', 'STMicro', 'STM Group'],
                    'Amplifon': ['Amplifon', 'Amplifon S.p.A.'],
                    'Tenaris': ['Tenaris', 'Tenaris S.p.A.'],
                    'Saipem': ['Saipem', 'Saipem S.p.A.'],
                    'DiaSorin': ['DiaSorin', 'DiaSorin S.p.A.'],
                    'Moncler': ['Moncler', 'Moncler S.p.A.'],
                    'Buzzi': ['Buzzi Unicem', 'Buzzi', 'Buzzi Unicem S.p.A.'],
                    'Hera': ['Hera', 'Hera S.p.A.', 'Gruppo Hera'],
                    'Italgas': ['Italgas', 'Italgas S.p.A.'],
                    'Azimut': ['Azimut', 'Azimut Holding'],
                    'Fineco': ['FinecoBank', 'Fineco', 'Fineco Banca'],
                    'Nexi': ['Nexi', 'Nexi S.p.A.'],
                    'A2A': ['A2A', 'A2A S.p.A.', 'A2A Spa'],
                    'Banco BPM': ['Banco BPM', 'BPM', 'Banco BPM S.p.A.'],
                    'BPER': ['BPER', 'BPER Banca'],
                    'Mediolanum': ['Mediolanum', 'Banca Mediolanum'],
                    'Brunello Cucinelli': ['Brunello Cucinelli', 'Cucinelli', 'Brunello Cucinelli S.p.A.'],
                    'Fincantieri': ['Fincantieri', 'Fincantieri S.p.A.'],
                    'INWIT': ['INWIT', 'INWIT S.p.A.'],
                    'Lottomatica': ['Lottomatica', 'Lottomatica S.p.A.', 'GTECH Lottomatica'],
                    'Pop Sondrio': ['Banca Popolare di Sondrio', 'Popolare Sondrio', 'BPS'],

                    // Settori e temi (utili per raggruppamento)
                    'Energia': ['energia', 'gas', 'petrolio', 'oil', 'gas naturale', 'elettrico', 'rinnovabili', 'transizione energetica'],
                    'Banche': ['banca', 'banche', 'credito', 'finanziario', 'prestiti', 'mutui', 'tassi', 'interesse'],
                    'Assicurazioni': ['assicurazione', 'assicurazioni', 'polizza', 'ramo I', 'ramo III', 'premi'],
                    'Automotive': ['auto', 'automotive', 'veicoli', 'auto elettriche', 'EV', 'ibrido'],
                    'TLC': ['telecom', 'telecomunicazioni', 'fibra', '5G', 'mobile', 'telefonia'],
                    'Utility': ['utility', 'servizi pubblici', 'rete', 'distribuzione', 'infrastrutture'],
                    'Lusso': ['lusso', 'fashion', 'moda', 'alta gamma', 'premium', 'orologi', 'gioielli'],
                    'Farmaceutica': ['farmaceutica', 'farmaci', 'vaccini', 'medicinali', 'salute', 'sanit√†']
                },
                
                settings: {
                    timeFilter: 24,
                    groupingMode: 'source',
                    newsLimit: 25,
                    highlightMIB40: true,
                    autoDetectTickers: true
                }
            };
            saveConfig();
            updateUI();
            showStatus('‚úÖ Ripristino completo effettuato', 'success');
        }

        // ========================================
        // NUOVA FUNZIONE RESET FEED MIB40
        // ========================================
        function resetFeedsMIB40() {
            if (!confirm('Caricare i feed ottimizzati per MIB40?\n\nI feed attuali verranno sostituiti con una selezione specifica per bluechip italiane.')) return;
            
            config.feeds = {
                'Borsa Italiana': [
                    'https://www.borsaitaliana.it/borsa/notizie/home/rss.xml',
                    'https://www.borsaitaliana.it/borsa/notizie/rss.xml'
                ],
                
                'Finanza Italiana - Milano Finanza': [
                    'https://www.milanofinanza.it/rss/mercati',
                    'https://www.milanofinanza.it/rss/economia'
                ],
                
                'Il Sole 24 Ore': [
                    'https://www.ilsole24ore.com/rss/finanza-e-mercati.xml',
                    'https://www.ilsole24ore.com/rss/italia.xml'
                ],
                
                'Teleborsa': [
                    'https://www.teleborsa.it/rss/ultimenews.xml'
                ],
                
                'Analisi e Trading': [
                    'https://www.investireoggi.it/feed/',
                    'https://www.tradingonline.it/feed/'
                ],
                
                'Finanza Personale': [
                    'https://www.soldionline.it/feed'
                ],
                
                'Economia Generale': [
                    'https://www.repubblica.it/rss/economia/rss2.0.xml',
                    'https://www.corriere.it/rss/economia.xml',
                    'https://www.ansa.it/sito/ansait_rss.xml'
                ],
                
                'Banche Centrali': [
                    'https://www.federalreserve.gov/feeds/press_all.xml',
                    'https://www.bancaditalia.it/media/notizie/rss/rss_comunicati.xml'
                ]
            };
            
            saveConfig();
            updateFeedsList();
            showStatus('‚úÖ Feed ottimizzati per MIB40 caricati', 'success');
        }

        function exportConfig() {
            try {
                const dataStr = JSON.stringify(config, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aggregatore-config-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('‚úÖ Configurazione esportata', 'success');
            } catch (e) {
                showStatus('‚ùå Errore nell\'esportazione', 'error');
            }
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    // Validazione struttura
                    if (!imported.feeds || !imported.keywords || !imported.settings) {
                        throw new Error('Struttura file non valida');
                    }
                    
                    if (confirm('Sostituire la configurazione corrente?\n\nLa configurazione attuale verr√† sovrascritta.')) {
                        config = imported;
                        saveConfig();
                        updateUI();
                        showStatus('‚úÖ Configurazione importata con successo', 'success');
                    }
                } catch (err) {
                    showStatus('‚ùå File di configurazione non valido', 'error');
                }
            };
            reader.onerror = () => showStatus('‚ùå Errore nella lettura del file', 'error');
            reader.readAsText(file);
            
            // Reset input per permettere re-import dello stesso file
            event.target.value = '';
        }

        // ========================================
        // NEWS LOADING & DISPLAY
        // ========================================
        async function loadNews() {
            const content = document.getElementById('newsContent');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Caricamento notizie in corso...</p>
                    <p class="text-center mt-2" style="color: var(--gray); font-size: 0.9rem;">
                        Questo potrebbe richiedere qualche secondo
                    </p>
                </div>
            `;
            
            newsData = [];
            allNews = {};

            try {
                // Raccogli tutte le promesse
                const fetchPromises = [];
                for (const [category, urls] of Object.entries(config.feeds)) {
                    for (const url of urls) {
                        fetchPromises.push(fetchRSSFeed(url, category));
                    }
                }

                // Esegui in parallelo
                const results = await Promise.allSettled(fetchPromises);
                
                // Processa risultati
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        newsData.push(...result.value);
                    }
                });

                // Filtra per tempo
                if (config.settings.timeFilter > 0) {
                    const cutoffTime = Date.now() - (config.settings.timeFilter * 60 * 60 * 1000);
                    newsData = newsData.filter(article => {
                        return !article.timestamp || article.timestamp >= cutoffTime;
                    });
                }

                // Rimuovi duplicati (stesso titolo e fonte)
                newsData = removeDuplicates(newsData);

                // Raggruppa
                if (config.settings.groupingMode === 'keyword') {
                    groupByKeyword();
                } else {
                    groupBySource();
                }

                // Mostra risultati
                displayNews();
                updateStats();
                
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('statsBar').classList.remove('hidden');
                
                const successMsg = newsData.length === 0 
                    ? 'Nessuna notizia trovata con i filtri correnti'
                    : `‚úÖ Caricate ${newsData.length} notizie`;
                
                showStatus(successMsg, newsData.length > 0 ? 'success' : 'warning');
                
            } catch (err) {
                console.error('Errore caricamento notizie:', err);
                showStatus(`‚ùå Errore: ${err.message}`, 'error');
                content.innerHTML = '<div class="error-box">Errore nel caricamento delle notizie. Riprova pi√π tardi.</div>';
            }
        }

        async function fetchRSSFeed(url, source) {
            try {
                // Usa proxy per evitare CORS
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 secondi timeout
                
                const response = await fetch(proxyUrl, { 
                    signal: controller.signal,
                    headers: {
                'Accept': 'application/xml, text/xml, */*',
                'User-Agent': 'Mozilla/5.0 (compatible; NewsAggregator/1.0)'
            }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const items = xml.querySelectorAll('item, entry');
                const articles = [];
                const limit = Math.min(config.settings.newsLimit, 50);
                
                items.forEach((item, index) => {
                    if (index >= limit) return;
                    
                    const title = item.querySelector('title')?.textContent?.trim() || '';
                    let link = item.querySelector('link')?.textContent?.trim() || 
                              item.querySelector('link')?.getAttribute('href') || 
                              item.querySelector('guid')?.textContent?.trim() || '';
                    
                    const pubDateStr = item.querySelector('pubDate, published, updated, date')?.textContent || '';
                    const timestamp = pubDateStr ? new Date(pubDateStr).getTime() : Date.now();
                    
                    if (title && link) {
                        articles.push({ 
                            title, 
                            link: link.trim(), 
                            pubDate: formatDate(pubDateStr),
                            timestamp,
                            source
                        });
                    }
                });
                
                return articles;
            } catch (err) {
                console.warn(`Errore feed ${source}:`, err.message);
                return []; // Ritorna array vuoto invece di fallire
            }
        }

        function removeDuplicates(articles) {
            const seen = new Set();
            return articles.filter(article => {
                const key = `${article.title.toLowerCase()}|${article.source}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function groupBySource() {
            allNews = {};
            newsData.forEach(article => {
                if (!allNews[article.source]) {
                    allNews[article.source] = [];
                }
                allNews[article.source].push(article);
            });
        }

        function groupByKeyword() {
            allNews = {};
            const uncategorized = [];

            newsData.forEach(article => {
                let categorized = false;
                const titleLower = article.title.toLowerCase();
                
                for (const [section, keywords] of Object.entries(config.keywords)) {
                    const found = keywords.some(keyword => {
                        const kwLower = keyword.toLowerCase();
                        
                        // Cerca come parola intera
                        if (titleLower === kwLower) return true;
                        
                        // Cerca con spazi/punteggiatura attorno
                        const regex = new RegExp(`\\b${kwLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                        if (regex.test(article.title)) return true;
                        
                        return false;
                    });
                    
                    if (found) {
                        if (!allNews[section]) allNews[section] = [];
                        allNews[section].push(article);
                        categorized = true;
                        break;
                    }
                }

                if (!categorized) {
                    uncategorized.push(article);
                }
            });

            if (uncategorized.length > 0) {
                allNews['Altre Notizie'] = uncategorized;
            }
        }

        function displayNews() {
            const content = document.getElementById('newsContent');
            
            if (newsData.length === 0) {
                content.innerHTML = `
                    <div class="config-section">
                        <div class="info-box">
                            <p>Nessuna notizia trovata con i filtri correnti.</p>
                            <p class="mt-1">Prova a:</p>
                            <ul style="margin-left: 20px; margin-top: 8px;">
                                <li>Modificare il filtro temporale</li>
                                <li>Aggiungere pi√π feed RSS</li>
                                <li>Verificare la connessione internet</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const [category, articles] of Object.entries(allNews)) {
                if (articles.length > 0) {
                    html += `
                        <div class="category fade-in">
                            <h2>
                                <span>${escapeHTML(category)}</span>
                                <span class="category-count">${articles.length} notizie</span>
                            </h2>
                            ${articles.map(article => {
                                // Rileva tickers MIB40
                                const mib40Tickers = detectMIB40Tickers(article.title);
                                const hasMIB40 = mib40Tickers.length > 0;
                                
                                let badgeHTML = '';
                                if (hasMIB40 && config.settings.highlightMIB40) {
                                    const companies = mib40Tickers.map(t => t.company).join(', ');
                                    badgeHTML = `
                                        <span class="mib40-badge" style="
                                            display: inline-block;
                                            background: linear-gradient(45deg, #667eea, #764ba2);
                                            color: white;
                                            padding: 4px 12px;
                                            border-radius: 20px;
                                            font-size: 0.75rem;
                                            font-weight: 600;
                                            margin-top: 8px;
                                            margin-right: 8px;
                                        ">
                                            üè∑Ô∏è MIB40: ${escapeHTML(companies)}
                                        </span>
                                    `;
                                }
                                
                                return `
                                    <div class="article" style="${hasMIB40 && config.settings.highlightMIB40 ? 'border-left: 4px solid #10b981;' : ''}">
                                        <div class="article-title">${escapeHTML(article.title)}</div>
                                        <a href="${escapeHTML(article.link)}" target="_blank" rel="noopener" class="article-link">
                                            üîó ${truncateUrl(article.link, 60)}
                                        </a>
                                        ${article.pubDate ? `
                                            <div class="article-date">
                                                <span>üìÖ</span>
                                                <span>${escapeHTML(article.pubDate)}</span>
                                            </div>
                                        ` : ''}
                                        ${badgeHTML}
                                        <span class="article-source">${escapeHTML(article.source)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }

            content.innerHTML = html;
            
            // Aggiungi CSS per badge MIB40
            if (!document.querySelector('#mib40-styles')) {
                const style = document.createElement('style');
                style.id = 'mib40-styles';
                style.textContent = `
                    .mib40-badge {
                        animation: pulse 2s infinite;
                    }
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.8; }
                        100% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function updateStats() {
            document.getElementById('totalNews').textContent = newsData.length;
            
            const last24h = newsData.filter(a => {
                return a.timestamp && a.timestamp >= (Date.now() - 24 * 60 * 60 * 1000);
            }).length;
            document.getElementById('news24h').textContent = last24h;
            document.getElementById('totalCategories').textContent = Object.keys(allNews).length;
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function escapeHTML(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateUrl(url, maxLength) {
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength - 3) + '...';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return dateStr;
            }
        }

        function showStatus(message, type = 'info') {
            const statusMsg = document.getElementById('statusMsg');
            let className = 'info-box';
            
            switch (type) {
                case 'error': className = 'error-box'; break;
                case 'warning': className = 'warning-box'; break;
                case 'success': className = 'info-box'; break;
            }
            
            statusMsg.innerHTML = `<div class="${className}">${escapeHTML(message)}</div>`;
            
            // Auto-remove dopo 5 secondi
            setTimeout(() => {
                if (statusMsg.innerHTML.includes(message)) {
                    statusMsg.innerHTML = '';
                }
            }, 5000);
        }

        function updateUI() {
            updateFeedsList();
            updateKeywordsList();
            document.getElementById('timeFilter').value = config.settings.timeFilter;
            document.getElementById('groupingMode').value = config.settings.groupingMode;
            document.getElementById('newsLimit').value = config.settings.newsLimit;
            document.getElementById('highlightMIB40').value = config.settings.highlightMIB40;
            document.getElementById('autoDetectTickers').value = config.settings.autoDetectTickers;
        }

        // ========================================
        // EXPORT TO HTML
        // ========================================
        function exportToHTML() {
            if (newsData.length === 0) {
                showStatus('‚ùå Nessuna notizia da esportare', 'error');
                return;
            }

            let htmlContent = `<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Notizie - ${new Date().toLocaleDateString('it-IT')}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; margin-bottom: 30px; }
        h2 { color: #333; margin-top: 40px; background: #f0f0f0; padding: 15px; border-left: 5px solid #667eea; border-radius: 5px; }
        .article { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #667eea; border-radius: 5px; }
        .article-title { font-weight: bold; color: #333; margin-bottom: 8px; font-size: 1.1em; }
        .article-link { color: #667eea; word-break: break-all; font-size: 0.9em; text-decoration: none; }
        .article-link:hover { text-decoration: underline; }
        .article-date { color: #666; font-size: 0.85em; margin-top: 8px; }
        .article-source { background: #e0e0e0; color: #666; padding: 4px 10px; border-radius: 12px; font-size: 0.75em; margin-top: 8px; display: inline-block; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #999; font-size: 0.9em; }
        .stats { background: #f0f4ff; padding: 20px; border-radius: 8px; margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat { text-align: center; }
        .stat-label { font-size: 0.9em; color: #666; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #667eea; margin-top: 5px; }
        @media print { 
            .article { page-break-inside: avoid; }
            h2 { page-break-before: always; }
        }
    </style>
</head>
<body>
    <h1>üìä Report Notizie Finanziarie</h1>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-label">Generato il</div>
            <div class="stat-value">${new Date().toLocaleString('it-IT')}</div>
        </div>
        <div class="stat">
            <div class="stat-label">Totale notizie</div>
            <div class="stat-value">${newsData.length}</div>
        </div>
        <div class="stat">
            <div class="stat-label">Modalit√†</div>
            <div class="stat-value">${config.settings.groupingMode === 'keyword' ? 'Parole Chiave' : 'Per Fonte'}</div>
        </div>
        <div class="stat">
            <div class="stat-label">Filtro temporale</div>
            <div class="stat-value">${config.settings.timeFilter > 0 ? config.settings.timeFilter + ' ore' : 'Tutte'}</div>
        </div>
    </div>`;

            for (const [category, articles] of Object.entries(allNews)) {
                if (articles.length > 0) {
                    htmlContent += `<h2>${escapeHTML(category)} (${articles.length} notizie)</h2>`;
                    articles.forEach(article => {
                        htmlContent += `
                            <div class="article">
                                <div class="article-title">${escapeHTML(article.title)}</div>
                                <a href="${escapeHTML(article.link)}" class="article-link" target="_blank">üîó ${escapeHTML(truncateUrl(article.link, 80))}</a>
                                ${article.pubDate ? `<div class="article-date">üìÖ ${escapeHTML(article.pubDate)}</div>` : ''}
                                <span class="article-source">${escapeHTML(article.source)}</span>
                            </div>
                        `;
                    });
                }
            }

            htmlContent += `
    <div class="footer">
        <p>Report generato automaticamente dall'Aggregatore Notizie Finanziarie</p>
        <p>Per stampare in PDF: Ctrl+P ‚Üí Salva come PDF</p>
    </div>
</body>
</html>`;

            try {
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notizie-finanziarie-${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('‚úÖ Report esportato con successo', 'success');
            } catch (e) {
                showStatus('‚ùå Errore nell\'esportazione', 'error');
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            
            // Inizializza input per mobile
            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('focus', () => {
                    if (window.innerWidth < 768) {
                        setTimeout(() => {
                            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                });
            });
            
            // Pulsante di emergenza per debug
            if (window.location.hash === '#debug') {
                const debugBtn = document.createElement('button');
                debugBtn.className = 'btn-danger mt-2';
                debugBtn.innerHTML = 'üóëÔ∏è Cancella Tutti i Dati';
                debugBtn.onclick = () => {
                    if (confirm('CANCELLARE TUTTI I DATI? Questo non si pu√≤ annullare!')) {
                        localStorage.clear();
                        location.reload();
                    }
                };
                document.querySelector('.config-section').appendChild(debugBtn);
            }
        });

        // Esponi funzioni globali
        window.loadNews = loadNews;
        window.exportToHTML = exportToHTML;
        window.switchTab = switchTab;
        window.addFeed = addFeed;
        window.removeFeed = removeFeed;
        window.addKeywordSection = addKeywordSection;
        window.removeKeywordSection = removeKeywordSection;
        window.saveSettings = saveSettings;
        window.resetSystemSettings = resetSystemSettings;
        window.resetFeeds = resetFeeds;
        window.resetKeywords = resetKeywords;
        window.resetFeedsMIB40 = resetFeedsMIB40;
        window.resetEverything = resetEverything;
        window.exportConfig = exportConfig;
        window.importConfig = importConfig;
    </script>





<script>

</script>



</body>



</html>